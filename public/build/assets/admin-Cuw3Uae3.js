const m=window.REAL_STATS||{totalArticles:0,totalUsers:0,totalComments:0,failedJobs:0};let d=window.REAL_ARTICLES||[{id:1,title:"Nâng cao chất lượng huấn luyện năm 2024",cat:"Huấn luyện chiến đấu",user:"Đại tá Nguyễn Văn A",status:"published",views:1250,content:"Nội dung bài viết mẫu về huấn luyện...",created_at:"2024-12-01T10:00:00Z",updated_at:"2024-12-01T10:00:00Z"},{id:2,title:"Đảm bảo kỹ thuật tăng thiết giáp",cat:"Hậu cần - Kỹ thuật",user:"Thiếu tá Trần Thị B",status:"draft",views:890,content:"Nội dung bài viết về kỹ thuật...",created_at:"2024-12-02T10:00:00Z",updated_at:"2024-12-02T10:00:00Z"}],s=window.REAL_USERS||[{id:1,name:"Đại tá Nguyễn Văn A",rank:"Đại tá",role:"Quản trị viên",email:"nguyenvana@qdnd.vn",joined:"15/01/2020"},{id:2,name:"Thiếu tá Trần Thị B",rank:"Thiếu tá",role:"Biên tập viên",email:"tranthib@qdnd.vn",joined:"22/03/2021"}];const b=window.REAL_CATEGORIES||[],I=window.REAL_LOGS||[];document.addEventListener("DOMContentLoaded",()=>{E(m),w(m),B(),g(d),f(s);const e=document.getElementById("article-cat");e&&e.options.length<=1&&b.length>0&&(e.options[0].value===""&&(e.innerHTML=""),b.forEach(l=>{const c=document.createElement("option");c.value=l.name,c.textContent=l.name,e.appendChild(c)})),window.lucide&&lucide.createIcons();const t=document.querySelector("#modal-article .btn-primary");t&&(t.onclick=x);const n=document.querySelector("#modal-user .btn-primary");n&&(n.onclick=S);const i=document.getElementById("create-article-form");i&&i.addEventListener("submit",function(l){l.preventDefault(),console.warn("Legacy create article form submitted. Consider integrating with new modal save logic.")})});function E(e){const t={"count-articles":e.totalArticles,"count-users":e.totalUsers,"stat-comments":e.totalComments,"stat-failed":e.failedJobs};for(const[n,i]of Object.entries(t)){const l=document.getElementById(n);l&&(l.innerText=Number(i||0).toLocaleString())}}let h;function w(e){const t=document.getElementById("mainChart");if(!t)return;h&&h.destroy();const n=["T2","T3","T4","T5","T6","T7","CN"],i=[Number(e.weeklyViews?.[0]||120),Number(e.weeklyViews?.[1]||190),Number(e.weeklyViews?.[2]||300),Number(e.weeklyViews?.[3]||500),Number(e.weeklyViews?.[4]||200),Number(e.weeklyViews?.[5]||300),Number(e.weeklyViews?.[6]||450)];h=new Chart(t.getContext("2d"),{type:"line",data:{labels:n,datasets:[{label:"Lượt xem bài viết",data:i,borderColor:"#48602a",backgroundColor:"rgba(72, 96, 42, 0.1)",fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1}})}function B(){const e=document.getElementById("log-list");if(!e)return;const t=I.length?I:[{time:"14:32:15",type:"success",message:"Cập nhật bài viết thành công"},{time:"14:28:42",type:"info",message:"Người dùng mới đăng ký"},{time:"14:15:08",type:"warning",message:"Dung lượng storage sắp đầy"},{time:"13:45:21",type:"error",message:"Lỗi kết nối database"}];e.innerHTML=t.map(n=>`
        <div style="display:flex; gap:12px; padding:8px; background:#fff; border-radius:6px; border-left:3px solid ${n.type==="success"?"#10b981":n.type==="info"?"#3b82f6":n.type==="warning"?"#f59e0b":"#ef4444"}">
            <span style="font-size:12px; color:#6b7280; min-width:70px">${n.time}</span>
            <span style="flex:1; color:#111">${n.message}</span>
        </div>
    `).join("")}function g(e=d){const t=document.getElementById("articles-table");t&&(t.innerHTML=e.map(n=>`
        <tr>
            <td style="padding:12px; text-align:left; font-weight:600; color:#374151;">#${n.id}</td>
            <td style="padding:12px; text-align:left; font-weight:600; color:#111827;">${y(n.title||"")}</td>
            <td style="padding:12px; text-align:left; color:#6b7280;">${y(n.user||"")}</td>
            <td style="padding:12px; text-align:left;">
                <span class="badge ${n.status==="published"?"badge-success":"badge-warning"}">
                    ${n.status==="published"?"Đã đăng":"Bản nháp"}
                </span>
            </td>
            <td style="padding:12px; text-align:center; color:#6b7280;">${$(n.views||0)}</td>
            <td style="padding:12px; text-align:center;">
                <button class="btn-table" onclick="populateAndOpenArticleModal(${n.id})" title="Chỉnh sửa">
                    <i data-lucide="edit-2" style="width:14px; color:#48602a;"></i>
                </button>
                <button class="btn-table" onclick="handleDeleteArticle(${n.id})" title="Xóa">
                    <i data-lucide="trash" style="width:14px; color:#dc2626;"></i>
                </button>
            </td>
        </tr>
    `).join(""),window.lucide&&lucide.createIcons())}function v(e=null){console.log("populateAndOpenArticleModal called with id:",e);const t=document.getElementById("modal-article");console.log("Modal element:",t),t.classList.add("flex"),t.style.display="flex",console.log("Modal classes after adding flex:",t.className),console.log("Modal style.display:",t.style.display);const n=document.getElementById("modal-article-title");if(e){const i=d.find(l=>l.id==e);i&&(document.getElementById("article-id").value=i.id,document.getElementById("article-title").value=i.title,document.getElementById("article-cat").value=i.cat,document.getElementById("article-user").value=i.user,document.getElementById("article-status").value=i.status,document.getElementById("article-views").value=i.views,document.getElementById("article-excerpt").value=i.excerpt||"",document.getElementById("article-content").value=i.content||"",n&&(n.innerText="Chỉnh sửa bài viết #"+e))}else document.getElementById("article-id").value="",document.getElementById("article-title").value="",document.getElementById("article-cat").value="",document.getElementById("article-user").value="Đại tá Nguyễn Văn A",document.getElementById("article-status").value="draft",document.getElementById("article-views").value=0,document.getElementById("article-excerpt").value="",document.getElementById("article-content").value="",document.getElementById("article-image").value="",n&&(n.innerText="Thêm bài viết mới");document.getElementById("modal-article").classList.add("flex")}function N(){console.log("openCreateArticle called from admin page"),v()}function x(){const e=document.getElementById("article-title").value.trim(),t=document.getElementById("article-cat").value,n=document.getElementById("article-content").value.trim();if(!e){alert("Vui lòng nhập tiêu đề bài viết!"),document.getElementById("article-title").focus();return}if(!t){alert("Vui lòng chọn chuyên mục!"),document.getElementById("article-cat").focus();return}if(!n){alert("Vui lòng nhập nội dung bài viết!"),document.getElementById("article-content").focus();return}const i=document.getElementById("save-article-btn"),l=document.getElementById("save-text"),c=document.getElementById("saving-text");i.disabled=!0,l.style.display="none",c.style.display="inline";const o={id:document.getElementById("article-id").value,title:e,cat:t,user:document.getElementById("article-user").value,status:document.getElementById("article-status").value,excerpt:document.getElementById("article-excerpt").value.trim(),content:n},a=document.getElementById("article-image");a.files&&a.files[0]&&(o.image=a.files[0],o.imageName=a.files[0].name),M(o,()=>{i.disabled=!1,l.style.display="inline",c.style.display="none"})}function M(e,t=null){const i={"Quốc phòng toàn dân":1,"Hậu cần - Kỹ thuật":2,"Huấn luyện chiến đấu":3,"Công tác Đảng":4}[e.cat]||1,l={"Đã xuất bản":"published","Bản nháp":"draft"},c={title:e.title,category_id:i,body:e.content||"",excerpt:e.excerpt||(e.content?e.content.substring(0,150)+"...":""),image_url:e.imageName?`/images/articles/${e.imageName}`:null,status:l[e.status]||"draft"},u=document.getElementById("modal-article");u&&u.classList.remove("flex"),e.id&&!isNaN(e.id)&&e.id<1e12?fetch(`/admin/articles/${e.id}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify(c)}).then(o=>o.json()).then(o=>{if(o.success){alert(o.message);const a=d.findIndex(p=>p.id==e.id);a!==-1&&(d[a]=o.article),g(d),updateStats(),t&&t()}else alert("Lỗi: "+(o.message||"Không thể cập nhật bài viết")),t&&t()}).catch(o=>{console.error("Error updating article:",o),alert("Có lỗi xảy ra khi cập nhật bài viết"),t&&t()}):fetch("/admin/articles",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify(c)}).then(o=>o.json()).then(o=>{if(o.success){alert(o.message+`
ID: `+o.article.id),d.unshift(o.article),g(d),updateStats();const a=document.getElementById("modal-article");a&&(a.classList.remove("flex"),a.style.display="none"),t&&t()}else{alert("Lỗi: "+(o.message||"Không thể tạo bài viết"));const a=document.getElementById("modal-article");a&&(a.classList.add("flex"),a.style.display="flex"),t&&t()}}).catch(o=>{console.error("Error creating article:",o),alert("Có lỗi xảy ra khi tạo bài viết");const a=document.getElementById("modal-article");a&&(a.classList.add("flex"),a.style.display="flex"),t&&t()})}function T(e){if(confirm("Bạn có chắc chắn muốn xóa bài viết này?")){const t=document.createElement("form");t.method="POST",t.action=`/admin/articles/${e}`;const n=document.createElement("input");n.type="hidden",n.name="_token",n.value=document.querySelector('meta[name="csrf-token"]').content,t.appendChild(n);const i=document.createElement("input");i.type="hidden",i.name="_method",i.value="DELETE",t.appendChild(i),document.body.appendChild(t),t.submit()}}function f(e=s){const t=document.getElementById("users-table");t&&(t.innerHTML=e.map(n=>`
        <tr>
            <td style="padding:12px; text-align:left; font-weight:600; color:#374151;">${n.id}</td>
            <td style="padding:12px; text-align:left; font-weight:600; color:#111827;">${y(n.name||"")}</td>
            <td style="padding:12px; text-align:left; color:#6b7280;">${y(n.email||"")}</td>
            <td style="padding:12px; text-align:left; color:#6b7280;">${y(n.role||"")}</td>
            <td style="padding:12px; text-align:center;">
                <button class="btn-table" onclick="populateAndOpenUserModal(${n.id})" title="Chỉnh sửa">
                    <i data-lucide="user-cog" style="width:14px; color:#48602a;"></i>
                </button>
                <button class="btn-table" onclick="handleDeleteUser(${n.id})" title="Xóa">
                    <i data-lucide="user-minus" style="width:14px; color:#dc2626;"></i>
                </button>
            </td>
        </tr>
    `).join(""),window.lucide&&lucide.createIcons())}function A(e=null){const t=document.getElementById("modal-user-title");if(e){const n=s.find(i=>i.id==e);n&&(document.getElementById("user-id").value=n.id,document.getElementById("user-name").value=n.name,document.getElementById("user-rank").value=n.rank,document.getElementById("user-role").value=n.role,document.getElementById("user-email").value=n.email,document.getElementById("user-joined").value=n.joined,t&&(t.innerText="Cập nhật hồ sơ nhân sự #"+e))}else document.getElementById("user-id").value="",document.getElementById("user-name").value="",document.getElementById("user-rank").value="",document.getElementById("user-role").value="",document.getElementById("user-email").value="",document.getElementById("user-joined").value="26/10/2024",t&&(t.innerText="Thêm nhân sự mới");document.getElementById("modal-user").classList.add("flex")}function S(){const t={id:document.getElementById("user-id").value,name:document.getElementById("user-name").value,rank:document.getElementById("user-rank").value,role:document.getElementById("user-role").value,email:document.getElementById("user-email").value,joined:document.getElementById("user-joined").value};O(t)}function O(e){const t=!e.id,n=t?"POST":"PUT",i=t?"/admin/users":`/admin/users/${e.id}`;fetch(i,{method:n,headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify(e)}).then(l=>l.json()).then(l=>{if(l.success){if(t)s.push(l.user);else{const c=s.findIndex(u=>u.id==e.id);c!==-1&&(s[c]={...s[c],...l.user})}f(s),updateStats(),document.getElementById("modal-user").classList.remove("flex"),alert(l.message||"Hồ sơ nhân sự đã được lưu.")}else alert(l.message||"Lỗi khi lưu hồ sơ nhân sự.")}).catch(l=>{console.error("Error saving user:",l),alert("Có lỗi xảy ra khi giao tiếp với server.")})}function L(e){confirm("Xóa nhân sự này?")&&fetch(`/admin/users/${e}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}}).then(t=>t.json()).then(t=>{t.success?(s=s.filter(n=>n.id!=e),f(s),updateStats(),alert(t.message||"Nhân sự đã được xóa.")):alert(t.message||"Lỗi khi xóa nhân sự.")}).catch(t=>{console.error("Error deleting user:",t),alert("Có lỗi xảy ra khi giao tiếp với server.")})}function $(e){return new Intl.NumberFormat("vi-VN").format(e||0)}function y(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function R(e){document.querySelectorAll('div[id^="view-"]').forEach(c=>c.classList.add("hidden"));const n=document.getElementById(`view-${e}`);n&&n.classList.remove("hidden"),document.querySelectorAll(".nav-item").forEach(c=>c.classList.remove("active"));const l=document.getElementById(`nav-${e}`);l&&l.classList.add("active"),e==="dashboard"?(E(m),w(m),B()):e==="articles"?g(d):e==="users"&&setTimeout(()=>f(s),100)}window.testModal=function(){console.log("TEST MODAL: Function called");const e=document.getElementById("modal-article");console.log("TEST MODAL: Modal element:",e),e?(console.log("TEST MODAL: Adding flex class"),e.classList.add("flex"),console.log("TEST MODAL: Modal should be visible now")):(console.error("TEST MODAL: Modal element not found!"),alert("Modal không tồn tại trong DOM!"))};window.switchView=R;window.closeModal=e=>{const t=document.getElementById(e);t&&t.classList.remove("flex")};window.openArticleModal=v;window.openUserModal=A;window.populateAndOpenArticleModal=v;window.handleDeleteArticle=T;window.populateAndOpenUserModal=A;window.handleDeleteUser=L;window.updateStats=()=>{E(m)};window.saveArticle=x;window.saveUser=S;window.deleteArticle=T;window.deleteUser=L;window.renderArticles=g;window.renderUsers=f;window.openCreateArticle=N;function k(){const e=document.getElementById("article-create-form-container");e&&(e.classList.toggle("hidden"),e.classList.contains("hidden")?document.getElementById("article-create-form").reset():(e.scrollIntoView({behavior:"smooth",block:"nearest"}),setTimeout(()=>{const t=document.getElementById("form-article-title");t&&t.focus()},100)),window.lucide&&lucide.createIcons())}function D(){const e=document.getElementById("article-create-form");if(!e)return;const t=document.getElementById("form-article-title").value.trim(),n=document.getElementById("form-article-category").value,i=document.getElementById("form-article-body").value.trim(),l=document.getElementById("form-article-excerpt").value.trim(),c=document.getElementById("form-article-image").value.trim(),u=document.querySelector('input[name="status"]:checked')?.value||"draft";if(!t){alert("Vui lòng nhập tiêu đề bài viết!"),document.getElementById("form-article-title").focus();return}if(!n){alert("Vui lòng chọn chuyên mục!"),document.getElementById("form-article-category").focus();return}if(!i){alert("Vui lòng nhập nội dung bài viết!"),document.getElementById("form-article-body").focus();return}const o=document.getElementById("submit-article-btn"),a=document.getElementById("submit-text"),p=document.getElementById("submit-loading");o.disabled=!0,a.style.display="none",p.style.display="inline";const C={title:t,category_id:parseInt(n),body:i,excerpt:l||null,image_url:c||null,status:u};fetch("/admin/articles",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify(C)}).then(r=>r.json()).then(r=>{r.success?(alert(r.message||"Bài viết đã được tạo thành công!"),r.article&&(d.unshift(r.article),g(d),m&&(m.totalArticles=d.length),updateStats()),e.reset(),k()):alert("Lỗi: "+(r.message||"Không thể tạo bài viết"))}).catch(r=>{console.error("Error creating article:",r),alert("Có lỗi xảy ra khi tạo bài viết. Vui lòng thử lại.")}).finally(()=>{o.disabled=!1,a.style.display="inline",p.style.display="none"})}window.toggleArticleForm=k;window.submitArticleForm=D;
