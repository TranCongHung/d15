const f=window.REAL_STATS||{totalArticles:0,totalUsers:0,totalComments:0,failedJobs:0};let s=window.REAL_ARTICLES||[{id:1,title:"Nâng cao chất lượng huấn luyện năm 2024",cat:"Huấn luyện chiến đấu",user:"Đại tá Nguyễn Văn A",status:"published",views:1250,content:"Nội dung bài viết mẫu về huấn luyện...",created_at:"2024-12-01T10:00:00Z",updated_at:"2024-12-01T10:00:00Z"},{id:2,title:"Đảm bảo kỹ thuật tăng thiết giáp",cat:"Hậu cần - Kỹ thuật",user:"Thiếu tá Trần Thị B",status:"draft",views:890,content:"Nội dung bài viết về kỹ thuật...",created_at:"2024-12-02T10:00:00Z",updated_at:"2024-12-02T10:00:00Z"}],r=window.REAL_USERS||[{id:1,name:"Đại tá Nguyễn Văn A",rank:"Đại tá",role:"Quản trị viên",email:"nguyenvana@qdnd.vn",joined:"15/01/2020"},{id:2,name:"Thiếu tá Trần Thị B",rank:"Thiếu tá",role:"Biên tập viên",email:"tranthib@qdnd.vn",joined:"22/03/2021"}];const B=window.REAL_CATEGORIES||[],w=window.REAL_LOGS||[];document.addEventListener("DOMContentLoaded",async()=>{await N(),A()});async function N(){try{const e=await(await fetch("/admin/stats")).json();document.getElementById("stat-articles").textContent=e.articles,document.getElementById("stat-users").textContent=e.users,document.getElementById("stat-comments").textContent=e.comments,document.getElementById("stat-failed").textContent=e.failed,e.categories&&e.categories.length>0&&b({categoryStats:e.categories}),console.log("Dashboard loaded successfully")}catch(t){console.error("Dashboard load failed:",t),document.getElementById("stat-articles").textContent="0",document.getElementById("stat-users").textContent="0",document.getElementById("stat-comments").textContent="0"}}const g=document.getElementById("article-cat");g&&g.options.length<=1&&B.length>0&&(g.options[0].value===""&&(g.innerHTML=""),B.forEach(t=>{const e=document.createElement("option");e.value=t.name,e.textContent=t.name,g.appendChild(e)}));window.lucide&&lucide.createIcons();const x=document.querySelector("#modal-article .btn-primary");x&&(x.onclick=L);const S=document.querySelector("#modal-user .btn-primary");S&&(S.onclick=M);const T=document.getElementById("create-article-form");T&&T.addEventListener("submit",function(t){t.preventDefault(),console.warn("Legacy create article form submitted. Consider integrating with new modal save logic.")});let v;function b(t={}){const e=document.getElementById("stats-chart");if(!e){console.warn("Chart canvas not found");return}const n=e.getContext("2d");if(!n)return;v&&v.destroy();const i=t.categoryStats||window.CATEGORY_STATS||[];if(i.length===0){console.warn("No category data available for chart");return}const o=i.map(l=>l.name),c=i.map(l=>l.count),u=["#48602a","#1e40af","#dc2626","#f59e0b","#8b5cf6","#06b6d4","#84cc16","#f97316"];v=new Chart(n,{type:"pie",data:{labels:o,datasets:[{label:"Bài viết",data:c,backgroundColor:u.map(l=>l+"40"),borderColor:u,borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{padding:20,usePointStyle:!0}},tooltip:{callbacks:{label:function(l){const a=l.raw||0,m=l.dataset.data.reduce((d,D)=>d+D,0),E=m>0?Math.round(a/m*100):0;return`${l.label}: ${a} bài viết (${E}%)`}}}}}})}function A(){const t=document.getElementById("log-list");if(!t)return;const e=w.length?w:[{time:"14:32:15",type:"success",message:"Cập nhật bài viết thành công"},{time:"14:28:42",type:"info",message:"Người dùng mới đăng ký"},{time:"14:15:08",type:"warning",message:"Dung lượng storage sắp đầy"},{time:"13:45:21",type:"error",message:"Lỗi kết nối database"}];t.innerHTML=e.map(n=>`
        <div style="display:flex; gap:12px; padding:8px; background:#fff; border-radius:6px; border-left:3px solid ${n.type==="success"?"#10b981":n.type==="info"?"#3b82f6":n.type==="warning"?"#f59e0b":"#ef4444"}">
            <span style="font-size:12px; color:#6b7280; min-width:70px">${n.time}</span>
            <span style="flex:1; color:#111">${n.message}</span>
        </div>
    `).join("")}function p(t=s){const e=document.getElementById("articles-table");e&&(e.innerHTML=t.map(n=>`
        <tr>
            <td style="padding:12px; text-align:left; font-weight:600; color:#374151;">#${n.id}</td>
            <td style="padding:12px; text-align:left; font-weight:600; color:#111827;">${y(n.title||"")}</td>
            <td style="padding:12px; text-align:left; color:#6b7280;">${y(n.user||"")}</td>
            <td style="padding:12px; text-align:left;">
                <span class="badge ${n.status==="published"?"badge-success":"badge-warning"}">
                    ${n.status==="published"?"Đã đăng":"Bản nháp"}
                </span>
            </td>
            <td style="padding:12px; text-align:center; color:#6b7280;">${U(n.views||0)}</td>
            <td style="padding:12px; text-align:center;">
                <button class="btn-table" onclick="populateAndOpenArticleModal(${n.id})" title="Chỉnh sửa">
                    <i data-lucide="edit-2" style="width:14px; color:#48602a;"></i>
                </button>
                <button class="btn-table" onclick="handleDeleteArticle(${n.id})" title="Xóa">
                    <i data-lucide="trash" style="width:14px; color:#dc2626;"></i>
                </button>
            </td>
        </tr>
    `).join(""),window.lucide&&lucide.createIcons())}function I(t=null){console.log("populateAndOpenArticleModal called with id:",t);const e=document.getElementById("modal-article");console.log("Modal element:",e),e.classList.add("flex"),e.style.display="flex",console.log("Modal classes after adding flex:",e.className),console.log("Modal style.display:",e.style.display);const n=document.getElementById("modal-article-title");if(t){const i=s.find(o=>o.id==t);i&&(document.getElementById("article-id").value=i.id,document.getElementById("article-title").value=i.title,document.getElementById("article-cat").value=i.cat,document.getElementById("article-user").value=i.user,document.getElementById("article-status").value=i.status,document.getElementById("article-views").value=i.views,document.getElementById("article-excerpt").value=i.excerpt||"",document.getElementById("article-content").value=i.content||"",n&&(n.innerText="Chỉnh sửa bài viết #"+t))}else document.getElementById("article-id").value="",document.getElementById("article-title").value="",document.getElementById("article-cat").value="",document.getElementById("article-user").value="Đại tá Nguyễn Văn A",document.getElementById("article-status").value="draft",document.getElementById("article-views").value=0,document.getElementById("article-excerpt").value="",document.getElementById("article-content").value="",document.getElementById("article-image").value="",n&&(n.innerText="Thêm bài viết mới");document.getElementById("modal-article").classList.add("flex")}function R(){console.log("openCreateArticle called from admin page"),I()}function L(){const t=document.getElementById("article-title").value.trim(),e=document.getElementById("article-cat").value,n=document.getElementById("article-content").value.trim();if(!t){alert("Vui lòng nhập tiêu đề bài viết!"),document.getElementById("article-title").focus();return}if(!e){alert("Vui lòng chọn chuyên mục!"),document.getElementById("article-cat").focus();return}if(!n){alert("Vui lòng nhập nội dung bài viết!"),document.getElementById("article-content").focus();return}const i=document.getElementById("save-article-btn"),o=document.getElementById("save-text"),c=document.getElementById("saving-text");i.disabled=!0,o.style.display="none",c.style.display="inline";const l={id:document.getElementById("article-id").value,title:t,cat:e,user:document.getElementById("article-user").value,status:document.getElementById("article-status").value,excerpt:document.getElementById("article-excerpt").value.trim(),content:n},a=document.getElementById("article-image");a.files&&a.files[0]&&(l.image=a.files[0],l.imageName=a.files[0].name),_(l,()=>{i.disabled=!1,o.style.display="inline",c.style.display="none"})}function _(t,e=null){const i={"Quốc phòng toàn dân":1,"Hậu cần - Kỹ thuật":2,"Huấn luyện chiến đấu":3,"Công tác Đảng":4}[t.cat]||1,o={"Đã xuất bản":"published","Bản nháp":"draft"},c={title:t.title,category_id:i,body:t.content||"",excerpt:t.excerpt||(t.content?t.content.substring(0,150)+"...":""),image_url:t.imageName?`/images/articles/${t.imageName}`:null,status:o[t.status]||"draft"},u=document.getElementById("modal-article");u&&u.classList.remove("flex"),t.id&&!isNaN(t.id)&&t.id<1e12?fetch(`/admin/articles/${t.id}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify(c)}).then(l=>l.json()).then(l=>{if(l.success){alert(l.message);const a=s.findIndex(m=>m.id==t.id);a!==-1&&(s[a]=l.article),p(s),updateStats(),e&&e()}else alert("Lỗi: "+(l.message||"Không thể cập nhật bài viết")),e&&e()}).catch(l=>{console.error("Error updating article:",l),alert("Có lỗi xảy ra khi cập nhật bài viết"),e&&e()}):fetch("/admin/articles",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify(c)}).then(l=>l.json()).then(l=>{if(l.success){alert(l.message+`
ID: `+l.article.id),s.unshift(l.article),p(s),updateStats();const a=document.getElementById("modal-article");a&&(a.classList.remove("flex"),a.style.display="none"),e&&e()}else{alert("Lỗi: "+(l.message||"Không thể tạo bài viết"));const a=document.getElementById("modal-article");a&&(a.classList.add("flex"),a.style.display="flex"),e&&e()}}).catch(l=>{console.error("Error creating article:",l),alert("Có lỗi xảy ra khi tạo bài viết");const a=document.getElementById("modal-article");a&&(a.classList.add("flex"),a.style.display="flex"),e&&e()})}function C(t){if(confirm("Bạn có chắc chắn muốn xóa bài viết này?")){const e=document.createElement("form");e.method="POST",e.action=`/admin/articles/${t}`;const n=document.createElement("input");n.type="hidden",n.name="_token",n.value=document.querySelector('meta[name="csrf-token"]').content,e.appendChild(n);const i=document.createElement("input");i.type="hidden",i.name="_method",i.value="DELETE",e.appendChild(i),document.body.appendChild(e),e.submit()}}function h(t=r){const e=document.getElementById("users-table");e&&(e.innerHTML=t.map(n=>`
        <tr>
            <td style="padding:12px; text-align:left; font-weight:600; color:#374151;">${n.id}</td>
            <td style="padding:12px; text-align:left; font-weight:600; color:#111827;">${y(n.name||"")}</td>
            <td style="padding:12px; text-align:left; color:#6b7280;">${y(n.email||"")}</td>
            <td style="padding:12px; text-align:left; color:#6b7280;">${y(n.role||"")}</td>
            <td style="padding:12px; text-align:center;">
                <button class="btn-table" onclick="populateAndOpenUserModal(${n.id})" title="Chỉnh sửa">
                    <i data-lucide="user-cog" style="width:14px; color:#48602a;"></i>
                </button>
                <button class="btn-table" onclick="handleDeleteUser(${n.id})" title="Xóa">
                    <i data-lucide="user-minus" style="width:14px; color:#dc2626;"></i>
                </button>
            </td>
        </tr>
    `).join(""),window.lucide&&lucide.createIcons())}function k(t=null){const e=document.getElementById("modal-user-title");if(t){const n=r.find(i=>i.id==t);n&&(document.getElementById("user-id").value=n.id,document.getElementById("user-name").value=n.name,document.getElementById("user-rank").value=n.rank,document.getElementById("user-role").value=n.role,document.getElementById("user-email").value=n.email,document.getElementById("user-joined").value=n.joined,e&&(e.innerText="Cập nhật hồ sơ nhân sự #"+t))}else document.getElementById("user-id").value="",document.getElementById("user-name").value="",document.getElementById("user-rank").value="",document.getElementById("user-role").value="",document.getElementById("user-email").value="",document.getElementById("user-joined").value="26/10/2024",e&&(e.innerText="Thêm nhân sự mới");document.getElementById("modal-user").classList.add("flex")}function M(){const e={id:document.getElementById("user-id").value,name:document.getElementById("user-name").value,rank:document.getElementById("user-rank").value,role:document.getElementById("user-role").value,email:document.getElementById("user-email").value,joined:document.getElementById("user-joined").value};j(e)}function j(t){const e=!t.id,n=e?"POST":"PUT",i=e?"/admin/users":`/admin/users/${t.id}`;fetch(i,{method:n,headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify(t)}).then(o=>o.json()).then(o=>{if(o.success){if(e)r.push(o.user);else{const c=r.findIndex(u=>u.id==t.id);c!==-1&&(r[c]={...r[c],...o.user})}h(r),updateStats(),document.getElementById("modal-user").classList.remove("flex"),alert(o.message||"Hồ sơ nhân sự đã được lưu.")}else alert(o.message||"Lỗi khi lưu hồ sơ nhân sự.")}).catch(o=>{console.error("Error saving user:",o),alert("Có lỗi xảy ra khi giao tiếp với server.")})}function O(t){confirm("Xóa nhân sự này?")&&fetch(`/admin/users/${t}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}}).then(e=>e.json()).then(e=>{e.success?(r=r.filter(n=>n.id!=t),h(r),updateStats(),alert(e.message||"Nhân sự đã được xóa.")):alert(e.message||"Lỗi khi xóa nhân sự.")}).catch(e=>{console.error("Error deleting user:",e),alert("Có lỗi xảy ra khi giao tiếp với server.")})}function U(t){return new Intl.NumberFormat("vi-VN").format(t||0)}function y(t){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function q(t){document.querySelectorAll('div[id^="view-"]').forEach(c=>c.classList.add("hidden"));const n=document.getElementById(`view-${t}`);n&&n.classList.remove("hidden"),document.querySelectorAll(".nav-item").forEach(c=>c.classList.remove("active"));const o=document.getElementById(`nav-${t}`);o&&o.classList.add("active"),t==="dashboard"?(renderDashboard(f),b(f),A()):t==="articles"?p(s):t==="users"&&setTimeout(()=>h(r),100)}window.testModal=function(){console.log("TEST MODAL: Function called");const t=document.getElementById("modal-article");console.log("TEST MODAL: Modal element:",t),t?(console.log("TEST MODAL: Adding flex class"),t.classList.add("flex"),console.log("TEST MODAL: Modal should be visible now")):(console.error("TEST MODAL: Modal element not found!"),alert("Modal không tồn tại trong DOM!"))};window.switchView=q;window.closeModal=t=>{const e=document.getElementById(t);e&&e.classList.remove("flex")};window.openArticleModal=I;window.openUserModal=k;window.populateAndOpenArticleModal=I;window.handleDeleteArticle=C;window.populateAndOpenUserModal=k;window.handleDeleteUser=O;window.updateStats=()=>{renderDashboard(f)};window.saveArticle=L;window.saveUser=M;window.deleteArticle=C;window.deleteUser=O;window.renderArticles=p;window.renderUsers=h;window.openCreateArticle=R;function $(){const t=document.getElementById("article-create-form-container");t&&(t.classList.toggle("hidden"),t.classList.contains("hidden")?document.getElementById("article-create-form").reset():(t.scrollIntoView({behavior:"smooth",block:"nearest"}),setTimeout(()=>{const e=document.getElementById("form-article-title");e&&e.focus()},100)),window.lucide&&lucide.createIcons())}function V(){const t=document.getElementById("article-create-form");if(!t)return;const e=document.getElementById("form-article-title").value.trim(),n=document.getElementById("form-article-category").value,i=document.getElementById("form-article-body").value.trim(),o=document.getElementById("form-article-excerpt").value.trim(),c=document.getElementById("form-article-image").value.trim(),u=document.querySelector('input[name="status"]:checked')?.value||"draft";if(!e){alert("Vui lòng nhập tiêu đề bài viết!"),document.getElementById("form-article-title").focus();return}if(!n){alert("Vui lòng chọn chuyên mục!"),document.getElementById("form-article-category").focus();return}if(!i){alert("Vui lòng nhập nội dung bài viết!"),document.getElementById("form-article-body").focus();return}const l=document.getElementById("submit-article-btn"),a=document.getElementById("submit-text"),m=document.getElementById("submit-loading");l.disabled=!0,a.style.display="none",m.style.display="inline";const E={title:e,category_id:parseInt(n),body:i,excerpt:o||null,image_url:c||null,status:u};fetch("/admin/articles",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify(E)}).then(d=>d.json()).then(d=>{d.success?(alert(d.message||"Bài viết đã được tạo thành công!"),d.article&&(s.unshift(d.article),p(s),f&&(f.totalArticles=s.length),updateStats()),t.reset(),$()):alert("Lỗi: "+(d.message||"Không thể tạo bài viết"))}).catch(d=>{console.error("Error creating article:",d),alert("Có lỗi xảy ra khi tạo bài viết. Vui lòng thử lại.")}).finally(()=>{l.disabled=!1,a.style.display="inline",m.style.display="none"})}window.toggleArticleForm=$;window.submitArticleForm=V;window.renderStatsChart=b;
